#!/bin/bash -e

ENV="$1"

if [ -z "$ENV" ]; then
    echo usage: $0 /etc/environment
    exit 1
fi

# skip if COREOS_PUBLIC_IPV4 is already set
if grep -qs ^COREOS_PUBLIC_IPV4 "$ENV"; then
    exit
fi

function get_interfaces {
    # just wait for interfaces to be ready
    while :; do
        ifaces=$(ifconfig | grep ^enp0 | cut -f1 -d: | tr "\n" " ")
        if [ -n "$ifaces" ]; then
            break
        fi
    done
    echo $ifaces
}

function get_ipv4 {
    # just wait for the interface to be ready
    while :; do
        ipv4=$(ifconfig $1 | grep 'inet ' | sed 's/^ *//' | cut -f 2 -d ' ')
        if [ -n "$ipv4" ]; then
            break
        fi
    done
    echo $ipv4
}

ifaces=$(get_interfaces)
ifaces=($ifaces)

private_ipv4=$(get_ipv4 ${ifaces[0]})

if [ -z "${ifaces[1]}" ]; then
    echo "COREOS_PUBLIC_IPV4=${private_ipv4}" >> "$ENV"
    echo "COREOS_PRIVATE_IPV4=${private_ipv4}" >> "$ENV"
    exit
fi

public_ipv4=$(get_ipv4 ${ifaces[1]})

echo "COREOS_PUBLIC_IPV4=${public_ipv4}" >> $ENV
echo "COREOS_PRIVATE_IPV4=${private_ipv4}" >> $ENV
